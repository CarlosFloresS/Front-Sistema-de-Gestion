<app-navbar></app-navbar>

<div class="form-page-container">
  <mat-card class="sale-card">
    <mat-card-header class="card-header">
      <mat-icon mat-card-avatar>receipt_long</mat-icon>
      <mat-card-title>Terminal de Venta</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Área de Entrada de Ítems -->
      <div class="item-entry-form" [formGroup]="itemForm">
        <mat-form-field appearance="fill" class="form-field product-field">
          <mat-label>Buscar producto</mat-label>
          <input matInput formControlName="producto" [matAutocomplete]="auto" />
          <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
            <mat-option *ngFor="let prod of filteredProducts$ | async" [value]="prod">
              <div class="option-layout">
                <span>{{ prod.nombre }}</span>
                <span class="option-stock">({{ prod.stock }} disp.)</span>
              </div>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field appearance="fill" class="form-field quantity-field">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="cantidad" min="1" />
          <mat-error *ngIf="itemForm.hasError('exceedStock')">
            Solo quedan {{ itemForm.getError('exceedStock').available }} disp.
          </mat-error>
        </mat-form-field>

        <button mat-flat-button class="add-item-btn" (click)="addItem()" [disabled]="itemForm.invalid">
          <mat-icon>add_shopping_cart</mat-icon>
          Añadir
        </button>
      </div>

      <!-- Resumen de la Venta (Tabla) -->
      <div class="sale-summary" *ngIf="detalles.controls.length > 0">
        <div class="table-container">
          <table mat-table [dataSource]="dataSource">

            <ng-container matColumnDef="producto">
              <th mat-header-cell *matHeaderCellDef>Producto</th>
              <td mat-cell *matCellDef="let element">{{ element.value.producto.nombre }}</td>
            </ng-container>

            <ng-container matColumnDef="cantidad">
              <th mat-header-cell *matHeaderCellDef class="align-center">Cantidad</th>
              <td mat-cell *matCellDef="let element" class="align-center">{{ element.value.cantidad }}</td>
            </ng-container>

            <ng-container matColumnDef="precio">
                <th mat-header-cell *matHeaderCellDef class="align-right">Precio Unit.</th>
                <td mat-cell *matCellDef="let element" class="align-right">{{ element.value.producto.precio | currency:'S/ ' }}</td>
            </ng-container>

            <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef class="align-right">Subtotal</th>
                <td mat-cell *matCellDef="let element" class="align-right">{{ (element.value.producto.precio * element.value.cantidad) | currency:'S/ ' }}</td>
            </ng-container>

            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element; let i = index" class="actions-cell">
                <button mat-icon-button class="remove-item-btn" (click)="removeItem(i)" matTooltip="Quitar">
                  <mat-icon>close</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" [@rowsAnimation]></tr>
          </table>
        </div>

        <!-- Total de la Venta -->
        <div class="total-summary">
            <h3>Total: <span>{{ totalVenta | currency:'S/ ' }}</span></h3>
        </div>
      </div>
    </mat-card-content>

    <!-- Acciones Finales -->
    <mat-card-actions class="form-actions" [formGroup]="ventaForm">
      <button mat-button type="button" (click)="cancel()">Cancelar Venta</button>
      <button mat-flat-button class="main-action-btn" (click)="submit()" [disabled]="ventaForm.invalid || isLoading">
        <span *ngIf="!isLoading">Registrar Venta ({{ detalles.controls.length }} ítems)</span>
        <mat-spinner *ngIf="isLoading" diameter="24"></mat-spinner>
      </button>
    </mat-card-actions>
  </mat-card>
</div>
